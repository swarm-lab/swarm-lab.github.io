<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>R vs Python - Round 2 (1/2)</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Welcome to the Swarm Lab where we study Swarm Intelligence in natural and artificial systems.">
    <link rel="canonical" href="http://www.theswarmlab.com/blog/rvspython/2014/01/12/r-vs-python-round-2-1/">

    <!-- Custom CSS & Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link rel="stylesheet" href="/style.css">

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href="http://fonts.googleapis.com/css?family=Ubuntu:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Kaushan+Script' rel='stylesheet' type='text/css'>
    <link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Google Analytics -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-2260031-8', 'auto');
        ga('send', 'pageview');

    </script>

    <!-- Favicon -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicon/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicon/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicon/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicon/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicon/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicon/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicon/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicon/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicon/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicon/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicon/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicon/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="&nbsp;"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="/img/favicon/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="/img/favicon/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="/img/favicon/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="/img/favicon/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="/img/favicon/mstile-310x310.png" />

</head>


<body id="nofront" class="index">

<!-- Navigation -->
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!--<a class="navbar-brand page-scroll" href="#page-top">Swarm Lab</a>-->
            <a class="navbar-brand page-scroll" href="/">
                <img src="/img/logos/swarmlab.png" alt=Swarm Lab style="height:250%; position: relative; top: -75%;">
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li class="hidden">
                    <a href="#page-top"></a>
                </li>
                <li>
                    <a class="page-scroll" href="/#about">About</a>
                </li>
                <!--<li>
                    <a class="page-scroll" href="#research">Research</a>
                </li>-->

                <li class="dropdown">
                    <a class="dropdown-toggle keep-open" data-toggle="dropdown" data-hover="dropdown" href="/#research">
                        Research<i class="fa fa-angle-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a class="page-scroll" href="/#research">Current research</a></li>
                        <li><a href="/publications">Publication list</a></li>
                        <li><a href="/media">In the media</a></li>
                    </ul>
                </li>

                <li>
                    <a class="page-scroll" href="/#teaching">Teaching</a>
                </li>
                <li>
                    <a class="page-scroll" href="/#dev">Dev</a>
                </li>
                <li class="dropdown">
                    <a class="dropdown-toggle keep-open" data-toggle="dropdown" data-hover="dropdown" href="/#team">
                        Team<i class="fa fa-angle-down"></i>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="/#team">Current members</a></li>
                        <li><a href="/previous_members">Previous members</a></li>
                        <li><a href="/join">Join the lab</a></li>
                    </ul>
                </li>
                <li>
                    <a class="page-scroll" href="/#contact">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>

<section class="bg-white post">

    <div class="entry">

        <h2>R vs Python - Round 2 (1/2)</h2>
        <h3></h3>

        <p>Written by Simon Garnier on January 12, 2014</p>

        <hr>

        <p><strong>Text by:</strong> Simon Garnier (<a href="http://www.theswarmlab.com">www.theswarmlab.com</a> / <a href="http://twitter.com/sjmgarnier">@sjmgarnier</a>)</p>

<p><strong>R code by:</strong> Simon Garnier (<a href="http://www.theswarmlab.com">www.theswarmlab.com</a> / <a href="http://twitter.com/sjmgarnier">@sjmgarnier</a>)</p>

<p><strong>Python code by:</strong> Randy Olson (<a href="http://www.randalolson.com">www.randalolson.com</a> / <a href="http://twitter.com/randal_olson">@randal_olson</a>)</p>

<p>Document generated with <a href="http://www.rstudio.com">RStudio</a>, <a href="http://yihui.name/knitr/">knitr</a>, and <a href="http://johnmacfarlane.net/pandoc/">pandoc</a>. Python figures generated with <a href="http://ipython.org/notebook.html">iPython Notebook</a>.</p>

<hr />

<h4 id="foreword">Foreword</h4>

<p>My friend Randy Olson and I got into the habit to argue about the relative qualities of our favorite languages for data analysis and visualization. I am an enthusiastic R user (<a href="http://www.r-project.org">www.r-project.org</a>) while  Randy is a fan of Python (<a href="http://www.python.org">www.python.org</a>). One thing we agree on however is that our discussions are meaningless unless we actually put R and Python to a series of tests to showcase their relative strengths and weaknesses. Essentially we will set a common goal (<em>e.g.</em>, perform a particular type of data analysis or draw a particular type of graph) and create the R and Python codes to achieve this goal. And since Randy and I are all about sharing, open source and open access, we decided to make public the results of our friendly challenges so that you can help us decide between R and Python and, hopefully, also learn something along the way.</p>

<hr />

<h4 id="todays-challenge-a-data-thief-manual-for-honest-scientists-part-1-of-2">Today’s challenge: a data thief manual for honest scientists (Part 1 of 2)</h4>

<h5 id="introduction">1 - Introduction</h5>

<p>Last week we started our challenge series with a rather simple task: plot a pretty barchart from some data collected by Randy for his recent post on the <a href="www.randalolson.com/2013/12/31/most-violence-packed-films/">“Top 25 most violence packed films” in the history of the movie industry</a>. Today we will try to up our game a little bit with a more complex task. We will show you how you can collect the data that Randy used for his post directly from the website they originate from (<a href="http://www.moviebodycounts.com">www.MovieBodyCounts.com</a>). This is called data scraping, or the art of taking advantage of the gigantic database that is the Internet.</p>

<p>The basic principle behind the scraping of website data is simple: a website is a like database, and each page of the website is like a table of this database. All we want is find in the database the tables that contain information that we would like to acquire, and then extract this information from within these relevant tables. This task can be relatively easy if all the pages of a website have a similar structure (<em>i.e.</em>, if the database is clean and well maintained). In this ideal situation, all we have to do is identify one or more stable markers that delimit the desired information and use them to tell R or Python what to save in memory. Unfortunately not all websites have a similar structure across all of their pages and it can quickly become a nightmare to identify such markers. Worse, sometimes you will have to resign yourself to scrape or correct part or all of the data manually.</p>

<p>For this challenge, we will attempt to recover the following pieces of information for each movie listed on <a href="http://www.moviebodycounts.com">www.MovieBodyCounts.com</a>: title, release year, count of on-screen deaths and link to the movie page on <a href="http://www.imdb.com">www.imdb.com</a> (this will help us for part 2 of this challenge next week). We will detail the different steps of the process and provide for each step the corresponding code. You will also find the entire codes at the end of this document.</p>

<h5 id="step-by-step-process">2 - Step by step process</h5>

<p>First things first, let’s set up our working environment by loading some necessary libraries.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Load libraries
</span><span class="n">library</span><span class="p">(</span><span class="n">RCurl</span><span class="p">)</span>      <span class="c1"># Everything necessary to grab webpages on the Web
</span><span class="n">library</span><span class="p">(</span><span class="n">XML</span><span class="p">)</span>        <span class="c1"># Everything necessary to parse XML and HTML code
</span><span class="n">library</span><span class="p">(</span><span class="n">pbapply</span><span class="p">)</span>    <span class="c1"># Progress bars!!! Just because why not :-)
</span>
<span class="c1"># Create curl handle which can be used for multiple HHTP requests. 
# followlocation = TRUE in case one of the URLs we want to grab is a redirection
# link.
</span><span class="n">curl</span> <span class="o">&lt;-</span> <span class="n">getCurlHandle</span><span class="p">(</span><span class="n">useragent</span> <span class="o">=</span> <span class="s2">"R"</span><span class="p">,</span> <span class="n">followlocation</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># String parsing libraries</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c"># urllib2 reads web pages if you provide it an URL</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="c"># html2text converts HTML to Markdown, which is much easier to parse</span>
<span class="kn">from</span> <span class="nn">html2text</span> <span class="kn">import</span> <span class="n">html2text</span></code></pre></div>

<p>Now a word about the organization of <a href="http://www.moviebodycounts.com">www.MovieBodyCounts.com</a>. To be perfectly honest, it is a bit messy :-) Movies are organized in a series of alphabetically ordered lists (by the first letter of each movie’s title), each letter having its own page (http://www.moviebodycounts.com/movies-[A-Z].htm). There is also a list for movies which title starts with a number (http://www.moviebodycounts.com/movies-numbers.htm). Finally, all category letters are capitalized in the lists’ URLs, except for letters v and x. Annoying, right? This is just one of the many little problems one can encounter when dealing with messy databases :-)</p>

<p>With all this information in mind, our first task is to create a list of all these lists.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Prepare URLs of the movie lists alphabetically ordered by first letter of
# movie title (capital A to Z, except for v and y) + "numbers" list (for movies
# which title starts with a number)
</span><span class="n">urls.by.letter</span> <span class="o">&lt;-</span> <span class="n">paste0</span><span class="p">(</span><span class="s2">"http://www.moviebodycounts.com/movies-"</span><span class="p">,</span> 
                         <span class="n">c</span><span class="p">(</span><span class="s2">"numbers"</span><span class="p">,</span> <span class="n">LETTERS</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">21</span><span class="p">],</span> <span class="s2">"v"</span><span class="p">,</span> <span class="s2">"W"</span> <span class="p">,</span> <span class="s2">"x"</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">,</span> <span class="s2">"Z"</span><span class="p">),</span> <span class="s2">".htm"</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Generate a list of all letters for the Movie pages (+ a "numbers" page)</span>
<span class="c"># MovieBodyCount's actor pages are all with capital letters EXCEPT v and x</span>
<span class="n">letters</span> <span class="o">=</span> <span class="p">[</span><span class="s">"numbers"</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">letters</span><span class="p">[</span><span class="mi">26</span><span class="p">:</span><span class="mi">52</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"V"</span><span class="p">,</span> <span class="s">"v"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"X"</span><span class="p">,</span> <span class="s">"x"</span><span class="p">))</span></code></pre></div>

<p>Our next task is to go through the HTML code of all these lists and gather the URLs of all the movie webpages. This is where the data scraping really starts.</p>

<p>As you will quickly notices by reading the following code, Randy and I have decided to use a different approach to identify and collect the desired URLs (and of all the data in the rest of this challenge). I have decided to rely on the <a href="http://www.w3schools.com/xpath/">XML Path Language (XPath)</a>, a language that makes it easy to navigate through elements and attributes in an XML/HTML document. Randy has decided to use an approach based on more “classical” string parsing and manipulation functions. Note that these are just personal preferences. XPath interpreters are also available in Python, and R is fully equipped for manipulating character strings.</p>

<p>For each movie list, we will…</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># For each movie list... For loops are frowned upon in R, let's use the classier
# apply functions instead. Here I use the pblapply from the pbapply package.
# It's equivalent to the regular lapply function, but it provides a neat 
# progress bar. Unlist to get a vector. 
</span><span class="n">urls.by.movie</span> <span class="o">&lt;-</span> <span class="n">unlist</span><span class="p">(</span><span class="n">pblapply</span><span class="p">(</span><span class="n">urls.by.letter</span><span class="p">,</span> <span class="n">FUN</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span> <span class="p">{</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">list_of_films</span> <span class="o">=</span> <span class="p">[]</span>
  
<span class="c"># Go through each movie list page and gather all of the movie web page URLs</span>
<span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span></code></pre></div>

<p>…download the raw HTML content of the webpage,…</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Load raw HTML
</span>  <span class="n">raw.html</span> <span class="o">&lt;-</span> <span class="n">getURL</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">curl</span> <span class="o">=</span> <span class="n">curl</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Read the raw HTML from the web page</span>
      <span class="n">page_text</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">"http://www.moviebodycounts.com/movies-"</span> <span class="o">+</span> <span class="n">letter</span> <span class="o">+</span> <span class="s">".htm"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></code></pre></div>

<p>…transform raw HTML into a more convenient format to work with,…</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Parse HTML content
</span>  <span class="n">parsed.html</span> <span class="o">&lt;-</span> <span class="n">htmlParse</span><span class="p">(</span><span class="n">raw.html</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Convert the raw HTML into Markdown</span>
      <span class="n">page_text</span> <span class="o">=</span> <span class="n">html2text</span><span class="p">(</span><span class="n">page_text</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span></code></pre></div>

<p>…find movie page entry, store the URL for later use and close the loop.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Extract desired links from HTML content using XPath. 
</span>  <span class="c1"># The desired links are all the URLs ("a/@href") directly following
</span>  <span class="c1"># ("/following::") the image which source file is called "graphic-movies.jpg" 
</span>  <span class="c1"># ("//img[@src='graphic-movies.jpg']").
</span>  <span class="n">links</span> <span class="o">&lt;-</span> <span class="n">as.vector</span><span class="p">(</span><span class="n">xpathSApply</span><span class="p">(</span><span class="n">parsed.html</span><span class="p">,</span> <span class="s2">"//img[@src='graphic-movies.jpg']/following::a/@href"</span><span class="p">))</span>

  <span class="c1"># Most links are relative URLs. Add root of the website to make them absolute.
</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is.null</span><span class="p">(</span><span class="n">links</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">grepl</span><span class="p">(</span><span class="s2">"http://www.moviebodycounts.com/"</span><span class="p">,</span> <span class="n">links</span><span class="p">)</span>                  <span class="c1"># Find relative URLs
</span>    <span class="n">links</span><span class="p">[</span><span class="o">!</span><span class="n">ix</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">paste0</span><span class="p">(</span><span class="s2">"http://www.moviebodycounts.com/"</span><span class="p">,</span> <span class="n">links</span><span class="p">[</span><span class="o">!</span><span class="n">ix</span><span class="p">])</span>   <span class="c1"># Add root of website to make URLs absolute
</span>    <span class="k">return</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}),</span> <span class="n">use.names</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">)</span> <span class="c1"># close the loop
</span>
<span class="c1"># One URL is actually just a symbolic link to another page. Let's get rid of it.
</span><span class="n">ix</span> <span class="o">&lt;-</span> <span class="n">which</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"movies-C.htm"</span><span class="p">,</span> <span class="n">urls.by.movie</span><span class="p">))</span>
<span class="n">urls.by.movie</span> <span class="o">&lt;-</span> <span class="n">urls.by.movie</span><span class="p">[</span><span class="o">-</span><span class="n">ix</span><span class="p">]</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Search through the web page for movie page entries</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">page_text</span><span class="p">:</span>
        <span class="c"># We know it's a movie page entry when it has ".htm" in it, but not ".jpg", "contact.htm", and "movies.htm"</span>
        <span class="c"># .jpg means it's a line with an image -- none of the movie entries have an image</span>
        <span class="c"># contact.htm and movies.htm means it's a link to the Contact or Movies page -- not what we want</span>
        <span class="c"># movies- means it's a redirect link to another page -- just skip over it</span>
        <span class="k">if</span> <span class="s">".htm"</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s">".jpg"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s">"contact.htm"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s">"movies.htm"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s">"movies-"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
          <span class="c">#print line</span>
          <span class="c"># The URL is in between parentheses (), so we can simply split the string on those</span>
          <span class="c"># Some URLs are full URLs, e.g. www.moviebodycounts.com/movie_name.html, so splitting on the / gives us only the page name</span>
          <span class="n">list_of_films</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"("</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">")"</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"/"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
      
    <span class="c"># If the movie list page doesn't exist, keep going</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">error with "</span> <span class="o">+</span> <span class="n">letter</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span></code></pre></div>

<p>Now that we know where to find each movie, we can start the hard part of this challenge. We will go through each movie webpage and attempt to find its title, release year, count of on-screen deaths and link to its page on <a href="http://www.imdb.com">www.imdb.com</a>. We will save all this information in a .csv file.</p>

<p>For each movie, we will…</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># For each movie... 
# do.call(rbind, ...) to reorganize the results in a nice data frame
</span><span class="n">data</span> <span class="o">&lt;-</span> <span class="n">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">pblapply</span><span class="p">(</span><span class="n">urls.by.movie</span><span class="p">,</span> <span class="n">FUN</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span> <span class="p">{</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Now that we have every movie web page URL, go through each movie page and</span>
<span class="c"># extract the movie name, kill counts, etc.</span>
<span class="n">out_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"film-death-counts.csv"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>
<span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Film,Year,Kill_Count,IMDB_url</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
  
<span class="k">for</span> <span class="n">film_page</span> <span class="ow">in</span> <span class="n">list_of_films</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span>
      <span class="c"># The information we're looking for on the page:</span>
      <span class="n">film</span> <span class="o">=</span> <span class="s">""</span>
      <span class="n">kills</span> <span class="o">=</span> <span class="s">""</span>
      <span class="n">year</span> <span class="o">=</span> <span class="s">""</span>
      <span class="n">IMDB_url</span> <span class="o">=</span> <span class="s">""</span>

      <span class="c"># A flag indicating that we've found the film title on the page</span>
      <span class="n">found_title</span> <span class="o">=</span> <span class="bp">False</span></code></pre></div>

<p>…download the raw HTML content of the webpage and transform raw HTML into a more convenient format to work with,…</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Load raw HTML
</span>  <span class="n">raw.html</span> <span class="o">&lt;-</span> <span class="n">getURL</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">curl</span> <span class="o">=</span> <span class="n">curl</span><span class="p">)</span>

  <span class="c1"># Parse HTML content
</span>  <span class="n">parsed.html</span> <span class="o">&lt;-</span> <span class="n">htmlParse</span><span class="p">(</span><span class="n">raw.html</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Read the page's raw HTML and convert it to Markdown (again) and go</span>
      <span class="c"># through each line</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">html2text</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">"http://www.moviebodycounts.com/"</span> <span class="o">+</span> <span class="n">film_page</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">):</span></code></pre></div>

<p>…attempt to find movie title,…</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Find movie title
</span>  <span class="c1"># Title appears inside a XML/HTML node called "title" ("//title"). In this
</span>  <span class="c1"># node, it comes after "Movie Body Counts: ". I use gsub to get rid off "Movie
</span>  <span class="c1"># Body Counts: " and keep only the movie title.
</span>  <span class="n">Film</span> <span class="o">&lt;-</span> <span class="n">xpathSApply</span><span class="p">(</span><span class="n">parsed.html</span><span class="p">,</span> <span class="s2">"//title"</span><span class="p">,</span> <span class="n">xmlValue</span><span class="p">)</span>
  <span class="n">Film</span> <span class="o">&lt;-</span> <span class="n">gsub</span><span class="p">(</span><span class="s2">"Movie Body Counts: "</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">Film</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># If we haven't found the title yet, these markers tell us we've found the movie</span>
<span class="c"># title</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_title</span> <span class="ow">and</span> <span class="s">"!"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s">"("</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s">"["</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
          <span class="n">film</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">","</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">":"</span><span class="p">)</span>
          <span class="n">found_title</span> <span class="o">=</span> <span class="bp">True</span></code></pre></div>

<p>…attempt to find movie year,…</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Find movie year
</span>  <span class="c1"># The year is usually a text inside ("/descendant::text()") a link node
</span>  <span class="c1"># ("//a") which source contains the string "charts-year" ("[contains(@href,
</span>  <span class="c1"># 'charts-year')]").
</span>  <span class="n">Year</span> <span class="o">&lt;-</span> <span class="n">as.numeric</span><span class="p">(</span><span class="n">xpathSApply</span><span class="p">(</span><span class="n">parsed.html</span><span class="p">,</span> <span class="s2">"//a[contains(@href, 'charts-year')]/descendant::text()"</span><span class="p">,</span> <span class="n">xmlValue</span><span class="p">))</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># The year is usually on a line with "charts-year"</span>
        <span class="k">if</span> <span class="s">"charts-year"</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
          <span class="n">year</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"["</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"]"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></code></pre></div>

<p>…attempt to find link to movie on IMDB,…</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Find IMDB link
</span>  <span class="c1"># The IMDB link is inside a link node ("//a") which source contains "imdb"
</span>  <span class="c1"># ("/@href[contains(.,'imdb')]")
</span>  <span class="n">IMDB_URL</span> <span class="o">&lt;-</span> <span class="n">as.vector</span><span class="p">(</span><span class="n">xpathSApply</span><span class="p">(</span><span class="n">parsed.html</span><span class="p">,</span> <span class="s2">"//a/@href[contains(.,'imdb')]"</span><span class="p">))[</span><span class="m">1</span><span class="p">]</span>

  <span class="c1"># Note: We select the first element of the vector because for at least one of
</span>  <span class="err">#</span> <span class="n">the</span> <span class="n">movies</span><span class="p">,</span> <span class="n">this</span> <span class="n">command</span> <span class="n">returns</span> <span class="n">two</span> <span class="n">links.</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># The IMDB url is on a line with "[imdb]"</span>
        <span class="k">if</span> <span class="s">"[imdb]"</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
          <span class="n">IMDB_url</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"[imdb]("</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">")"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></code></pre></div>

<p>… and finally attempt to find the on-screen kill count. Here, Randy chose an approach that minimizes his coding effort, but that will potentially force him to make several manual corrections a posteriori. I chose to find a solution that works with minimal to no manual corrections, but that requires an extra coding effort. Whichever approach is best depends mostly on the size of the data you want to scrape and the time you have to do it.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Find kill count.
</span>  <span class="c1"># Kill count is contained in the first non-empty text node
</span>  <span class="c1"># ("/following::text()[normalize-space()]") after the image which source file
</span>  <span class="c1"># is called "graphic-bc.jpg" ("//img[@src='graphic-bc.jpg']")
</span>  <span class="n">Body_Count</span> <span class="o">&lt;-</span> <span class="n">xpathSApply</span><span class="p">(</span><span class="n">parsed.html</span><span class="p">,</span> <span class="s2">"//img[@src='graphic-bc.jpg']/following::text()[normalize-space()]"</span><span class="p">,</span> <span class="n">xmlValue</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span>

  <span class="c1"># Now we need to clean up the text node that we just extracted because there
</span>  <span class="c1"># are lots of inconsistencies in the way the kill counts are displayed across
</span>  <span class="c1"># all movie pages. For instance, counts are sometimes accompanied by text, not
</span>  <span class="c1"># always the same, and sometimes there is no text at all. Sometimes the total
</span>  <span class="c1"># count is split in two numbers (e.g., number of dead humans and number of
</span>  <span class="c1"># dead aliens). And sometimes the total count is displayed and accompanied by
</span>  <span class="c1"># a split count in parenthesis. First, let's remove everything that is
</span>  <span class="c1"># writtent in parenthesis or that is not a number.
</span>  <span class="c1"># Using gsub, remove everything in parenthesis and all non number characters
</span>  <span class="n">Body_Count</span> <span class="o">&lt;-</span> <span class="n">gsub</span><span class="p">(</span><span class="s2">"\\(.*?\\)"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">,</span> <span class="n">Body_Count</span><span class="p">)</span>
  <span class="n">Body_Count</span> <span class="o">&lt;-</span> <span class="n">gsub</span><span class="p">(</span><span class="s2">"[^0-9]+"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">,</span> <span class="n">Body_Count</span><span class="p">)</span>
  
  <span class="c1"># In case the total count has been split, we want to separate these numbers
</span>  <span class="c1"># from each other so that we can add them up later. Using strsplit, split the
</span>  <span class="c1"># character string at spaces
</span>  <span class="n">Body_Count</span> <span class="o">&lt;-</span> <span class="n">unlist</span><span class="p">(</span><span class="n">strsplit</span><span class="p">(</span><span class="n">Body_Count</span><span class="p">,</span> <span class="s2">" "</span><span class="p">))</span>
  
  <span class="c1"># For now, we have extracted characters. Transform them into numbers.
</span>  <span class="n">Body_Count</span> <span class="o">&lt;-</span> <span class="n">as.numeric</span><span class="p">(</span><span class="n">Body_Count</span><span class="p">)</span>
  
  <span class="c1"># Sum up the numbers (in case they have been split into separate categories.
</span>  <span class="n">Body_Count</span> <span class="o">&lt;-</span> <span class="n">sum</span><span class="p">(</span><span class="n">Body_Count</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># The kill counts are usually on a line with "Film:"</span>
        <span class="k">if</span> <span class="s">"film:"</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s">"kills:"</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s">"count:"</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
          <span class="n">kills</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"[^0-9]"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"("</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span></code></pre></div>

<p>Almost done! Now we just need to close the loop and write the data frame into a .csv file</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Return scraped data into a data frame form
</span>  <span class="k">return</span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="n">IMDB_URL</span><span class="p">,</span> <span class="n">Film</span><span class="p">,</span> <span class="n">Year</span><span class="p">,</span> <span class="n">Body_Count</span><span class="p">))</span>
<span class="p">}))</span>

<span class="c1"># Save scraped data in a .csv file for future use
</span><span class="n">write.csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">"movies-R.csv"</span><span class="p">,</span> <span class="n">row.names</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">film</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">kills</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">IMDB_url</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

    <span class="c"># If a movie page fails to open, print out the error and move on to the next movie</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span> <span class="n">film_page</span>
    <span class="k">print</span> <span class="n">e</span>

<span class="n">out_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>

<p>And voilà! You should now have a .csv file somewhere on your computer containing all the information we just scraped from the website. Not too hard, right?</p>

<p>Keep the .csv file, we will use it again next week to complete this challenge by scraping additional information from <a href="http://www.imdb.com">www.imdb.com</a>.</p>

<hr />

<h4 id="source-code">3 - Source code</h4>

<p>R and Python source codes are available <a href="https://github.com/morpionZ/R-vs-Python/tree/master/Deadliest%20movies%20scrape/code">here</a>.</p>

<hr />

<h4 id="bonus-for-the-braves">4 - Bonus for the braves</h4>

<p>Today’s challenge was code and text heavy. No pretty pictures to please the eye. So, for all the brave people who made it to the end, here is a cat picture :-) </p>

<p><img src="/img/posts/2014-01-12-r-vs-python-round-2-1/programming_cat.jpg" alt="Programming cat" class="full" /></p>


        <hr>

        <p>Categories:
            
                
                    <a href="/blog/">blog</a> &bull;
                
            
                
                    <a href="/category/rvspython/">rvspython</a> &bull;
                
            
        </p>

        <hr>

<<<<<<< HEAD
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'theswarmlab';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
=======
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'theswarmlab';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
>>>>>>> ba8699efb578130ab0155c9c5aea221afbfd6216
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>

</section>

<footer class="bg-darkest-gray">
    <div class="container">
        <span style="color: white">Subscribe <a href="/feed.xml">via RSS</a></span>
    </div>
</footer>

  <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <span class="copyright">Copyright &copy; Swarm Lab 2015</span>
                </div>
                <div class="col-md-4">
                    <ul class="list-inline social-buttons">
                        
                        <li><a href="https://twitter.com/sjmgarnier"><i class="fa fa-twitter"></i></a>
                        </li>
                        
                        <li><a href="https://plus.google.com/u/0/+SimonGarnier"><i class="fa fa-google-plus"></i></a>
                        </li>
                        
                        <li><a href="https://github.com/swarm-lab"><i class="fa fa-github"></i></a>
                        </li>
                        
                        <li><a href="https://www.linkedin.com/in/simongarnier"><i class="fa fa-linkedin"></i></a>
                        </li>
                        
                    </ul>
                </div>
                <div class="col-md-4">
                    <ul class="list-inline quicklinks">
                        <!--<li><a href="#">Privacy Policy</a>
                        </li>
                        <li><a href="#">Terms of Use</a>
                        </li>-->
                    </ul>
                </div>
            </div>
        </div>
    </footer>
 <!-- jQuery Version 1.11.0 -->
    <script src="/js/jquery-1.11.0.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="/js/jquery.easing.min.js"></script>
    <script src="/js/classie.js"></script>
    <script src="/js/cbpAnimatedHeader.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="/js/jqBootstrapValidation.js"></script>
    <script src="/js/contact_me.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/js/agency.js"></script>


</body>
</html>
